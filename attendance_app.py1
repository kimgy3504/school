import streamlit as st
import pandas as pd
import datetime
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import calendar

# 1ï¸âƒ£ í•™ìƒ ëª©ë¡ ì •ì˜
students = ["í™ê¸¸ë™", "ê¹€ì² ìˆ˜", "ì´ì˜í¬", "ë°•ì˜ìˆ˜", "ìµœì§€ì—°"]  # ì›í•˜ëŠ” ë§Œí¼ ì¶”ê°€

# 2ï¸âƒ£ Google Sheets ì—°ê²°
def connect_sheet(sheet_name):
    scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
    creds = ServiceAccountCredentials.from_json_keyfile_name("credentials.json", scope)
    client = gspread.authorize(creds)
    sheet = client.open(sheet_name).sheet1
    return sheet

# 3ï¸âƒ£ Streamlit UI
st.set_page_config(page_title="ì¶œì„ë¶€", layout="centered")
st.title("ğŸ“ ì¶œì„ ì²´í¬ (ê²°ì„ìë§Œ ì…ë ¥í•˜ì„¸ìš”)")

today = datetime.date.today()
weekday = calendar.day_name[today.weekday()]  # ìš”ì¼ ì´ë¦„ (Monday ~ Sunday)

st.write(f"ì˜¤ëŠ˜ì€ **{today} ({weekday})**ì…ë‹ˆë‹¤.")

# Google Sheets ì—°ê²°
SHEET_NAME = "ì¶œì„ë¶€ ê¸°ë¡"  # ì§ì ‘ ë§Œë“  ì‹œíŠ¸ ì´ë¦„
sheet = connect_sheet(SHEET_NAME)

# 4ï¸âƒ£ ê²°ì„ ì…ë ¥
st.subheader("ğŸ™‹â€â™€ï¸ ê²°ì„í•œ ì¹œêµ¬ë§Œ ì„ íƒí•´ì£¼ì„¸ìš”")

absent_name = st.selectbox("ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”", [""] + students)
if absent_name:
    reason = st.text_input("ê²°ì„ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”", "")
    if st.button("ì œì¶œí•˜ê¸°"):
        sheet.append_row([str(today), weekday, absent_name, "ê²°ì„", reason])
        st.success("ê²°ì„ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

# 5ï¸âƒ£ ì¶œì„ì ìë™ ì²˜ë¦¬
if st.button("ìë™ ì¶œì„ ì²˜ë¦¬"):
    # ì´ë¯¸ ê¸°ë¡ëœ í•™ìƒ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ì¤‘ë³µ ë°©ì§€)
    all_records = sheet.get_all_records()
    recorded_names = [row["ì´ë¦„"] for row in all_records if row["ë‚ ì§œ"] == str(today)]

    for name in students:
        if name not in recorded_names:
            sheet.append_row([str(today), weekday, name, "ì¶œì„", ""])
    st.success("ì¶œì„ì ìë™ ê¸°ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
